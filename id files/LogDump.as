/**
 * ...
 * @author fox
 */
import com.GameInterface.LogBase;
import com.GameInterface.QuestsBase;
import com.GameInterface.UtilsBase;
import com.Utils.LDBFormat;
import com.fox.DoubleAgent.App;
import mx.utils.Delegate;


// Replaces the main.as in project files
// "Done" will be printed out in the system channel once done
// Afterwards run ExtractFromClientlog.py and then jsonToXML.py
// json files are for processing the data and .xml files are needed by the mod
class com.fox.DoubleAgent.Main {
	private static var s_app:App;
	static var SharedID:Array;
	static var LumieID:Array;
	static var DragonID:Array;
	static var TemplarID:Array;

	public static function main(swfRoot:MovieClip):Void {
		s_app = new App(swfRoot);
		swfRoot.onLoad = OnLoad;
		swfRoot.onUnload = OnUnload;
	}

	public function Main() { }

	public static function OnLoad() {
		//s_app.onLoad();
		
		//Starts 30s after launching the game,you have to login before the timer expires
		//Alternatively remove "GMF_PRELOAD" flag from modules.xml and remove the setTimeout part
		setTimeout(Delegate.create(Main, Importer), 30000);
	}

	public static function OnUnload() {
		s_app.onUnload();
	}
	
	public static function Importer() {
		SharedID = new Array(15193, 15209, 15211, 15213, 15217, 15220, 15230, 15237, 15239, 15242, 15279, 15339, 15354, 15401, 15422, 15459, 15471, 15492, 15496, 15500, 15505, 15507, 15512, 15563, 15567, 15577, 15583, 15584, 15598, 15607, 15613, 15633, 15648, 15658, 15674, 15723, 15774, 15791, 15818, 15819, 15853, 15854, 15855, 15873, 15885, 15902, 15911, 15915, 15917, 15918, 15919, 15921, 15955, 15992, 15996, 16023, 16043, 16057, 16069, 16077, 16107, 16136, 16141, 16162, 16200, 16253, 16262, 16286, 16298, 16320, 16334, 16346, 16365, 16373, 16393, 16394, 16397, 16410, 16447, 16472, 16477, 16483, 16488, 16490, 16492, 16493, 16507, 16514, 16518, 16522, 16525, 16536, 16540, 16547, 16549, 16557, 16567, 16571, 16579, 16597, 16606, 16612, 16660, 16671, 16684, 16685, 16688, 16689, 16721, 16743, 16748, 16750, 16762, 16770, 16774, 16775, 16777, 16778, 16787, 16805, 16806, 16807, 16811, 16821, 16823, 16831, 16832, 16833, 16837, 16839, 16847, 16854, 16864, 16865, 16870, 16873, 16876, 16878, 16879, 16883, 16885, 16886, 16887, 16888, 16889, 16890, 16905, 16908, 16909, 16911, 16913, 16915, 16916, 16920, 16922, 16925, 16928, 16929, 16931, 16932, 16933, 16934, 16935, 16937, 16942, 16954, 16966, 16968, 16970, 16982, 16987, 16990, 16995, 16996, 16998, 17003, 17030, 17034, 17038, 17041, 17042, 17045, 17049, 17082, 17084, 17102, 17118, 17142, 17178, 17191, 17200, 17225, 17246, 17260, 17272, 17273, 17274, 17284, 17287, 17290, 17291, 17311, 17318, 17334, 17352, 17353, 17354, 17355, 17361, 17363, 17376, 17378, 17382, 17395, 17400, 17404, 17409, 17422, 17424, 17431, 17447, 17473, 17495, 17513, 17555, 17556, 17557, 17562, 17574, 17610, 17621, 17798, 17811, 17813, 17816, 17823, 17824, 17829, 17833, 17834, 17836, 17837, 17841, 17842, 17843, 17858, 17867, 17881, 17882, 17883, 17892, 17895, 17901, 17916, 17917, 17929, 17930, 17932, 17941, 17945, 17947, 17961, 17962, 17965, 17967, 17978, 18074, 18122, 18127, 18132, 18134, 18138, 18145, 18197, 18198, 18201, 18204, 18208, 18210, 18212, 18224, 18236, 18242, 18244, 18250, 18272, 18282, 18310, 18312, 18314, 18320, 18321, 18325, 18329, 18336, 18345, 18350, 18357, 18358, 18367, 18368, 18382, 18401, 18405, 18406, 18410, 18412, 18446, 18452, 18453, 18454, 18455, 18456, 18465, 18466, 18467, 18478, 18487, 18494, 18495, 18497, 18499, 18503, 18505, 18509, 18515, 18516, 18522, 18530, 18536, 18538, 18541, 18548, 18550, 18560, 18564, 18569, 18571, 18574, 18578, 18583, 18586, 18592, 18620, 18644, 18647, 18665, 18666, 18667, 18669, 18686, 18695, 18699, 18716, 18728, 18738, 18744, 18753, 18755, 18763, 18772, 18796, 18802, 18808, 18810, 18813, 18817, 18823, 18866, 18867, 18868, 18869, 18871, 18884, 18892, 18893, 18910, 18917, 18926, 18927, 18940, 18952, 18992, 19024, 19026, 19044, 19050, 19057, 19063, 19084, 19089, 19126, 19167, 19168, 19172, 19173, 19174, 19175, 19176, 19178, 19180, 19186, 19187, 19199, 19200, 19201, 19202, 19205, 19206, 19212, 19214, 19217, 19218, 19230, 19267, 19279, 19285, 19303, 19304, 19305, 19325, 19367, 19400, 19403, 19435, 19470, 19513, 19536, 19549, 19615, 19734, 20055, 20057, 20071, 20072, 20073, 20074, 20075, 20076, 20083, 20147, 20309, 20312, 20313, 20314, 20322, 20323, 20325, 20327, 20329, 20352, 20353, 20354, 20357, 20359, 20360, 20362, 20369, 20428, 20429, 20432, 20513, 20514, 20515, 20516, 20523, 20524, 20525, 20526, 20527, 20528, 20529, 20530, 20531, 20532, 20533, 20534, 20535, 20752, 20753, 20771, 20772, 20773, 20776, 20805, 20818, 20828, 20858, 20859, 20860, 20861, 20862, 20863, 20864, 20865, 20879, 20891, 20892, 20893, 20894, 20896, 20897, 20904, 20924, 20978, 20979, 20980, 20982, 20983, 20984, 20986, 20987, 20988, 20990, 20991, 20992, 20993, 20994, 20995, 20996, 20997, 21002, 21003, 21004, 21005, 21006, 21007, 21008, 21009, 21030, 21034, 21035, 21036, 21037, 21039, 21040, 21041, 21042, 21043, 21044, 21087, 21089, 21091, 21093, 21095, 21097, 21120, 21128, 21130, 21131, 21132, 21133, 21134, 21135, 21136, 21137, 21154, 21157, 21160, 21161, 21163, 21166, 21168, 21170, 21172, 21174, 21178, 21203, 21213, 21224, 21235, 21240, 21241, 21242, 21243, 21244, 21248, 21252, 21253, 21254, 21274, 21285, 21286, 21287, 21288, 21289, 21290, 21291, 21292, 21293, 21294, 21295, 21296, 21297, 21298, 21302, 21303, 21304, 21305, 21306, 21319, 21321, 21322, 21323, 21324, 21325, 21326, 21327, 21328, 21329, 21330, 21331, 21332, 21333, 21334, 21382, 21385, 21386, 21387, 21388, 21389, 21390, 21391)
		LumieID = new Array(15401,15422,15492,15494,15496,15500,15563,15567,15577,15583,15598,15607,15613,15633,15648,15658,15674,15774,15791,15853,15854,15855,15885,15911,15996,16005,16023,16043,16069,16077,16123,16131,16136,16141,16262,16334,16357,16365,16373,16393,16397,16410,16441,16442,16485,16507,16508,16514,16518,16522,16528,16534,16579,16597,16606,16660,16685,16704,16748,16833,16847,16849,16865,16883,16913,16941,16955,16996,16998,17030,17102,17118,17127,17142,17174,17178,17191,17200,17220,17223,17230,17246,17251,17272,17274,17290,17291,17299,17309,17311,17317,17349,17352,17354,17363,17370,17371,17376,17382,17391,17422,17428,17447,17452,17473,17480,17495,17498,17502,17513,17555,17557,17574,17596,17603,17610,17643,17659,17675,17685,17705,17767,17783,17798,17809,17811,17813,17816,17823,17829,17846,17864,17866,17870,17878,17892,17932,18071,18082,18087,18088,18131,18134,18138,18152,18156,18177,18197,18204,18212,18232,18236,18242,18244,18272,18282,18310,18312,18321,18322,18329,18336,18345,18358,18367,18368,18380,18394,18401,18406,18444,18446,18465,18467,18477,18478,18485,18487,18494,18497,18499,18505,18516,18522,18538,18541,18560,18564,18569,18571,18583,18586,18620,18651,18667,18669,18695,18699,18716,18728,18760,18763,18774,18777,18784,18802,18813,18828,18837,18846,18866,18871,18878,18881,18884,18892,18910,18917,18948,18951,18952,18997,19001,19013,19019,19112,19120,19126,19154,19163,19171,19180,19183,19185,19203,19204,19206,19207,19212,19214,19216,19217,19218,19230,19266,19268,19276,19277,19278,19279,19284,19285,19303,19304,19305,19315,19321,19323,19332,19333,19337,19342,19350,19362,19367,19379,19385,19397,19398,19399,19402,19403,19404,19405,19414,19436,19448,19455,19456,19466,19475,19479,19489,19498,19532,19537,19551,19555,19565,19570,19577,19584,19586,19590,19591,19592,19601,19604,19618,19623,19624,19631,19636,19639,19663,19676,19679,19688,19690,19691,19693,19707,19708,19709,19710,19711,19712,19713,19714,19715,19716,19719,19720,19721,19740,19749,19766,19771,19772,19786,19787,19788,19804,19805,19811,19812,19817,19823,19831,19849,19857,19858,19859,19861,19862,19863,19866,19870,19873,19896,19899,19900,19902,19903,19904,19907,19909,19921,19931,19941,19942,19943,19946,19956,19967,19970,19974,19976,19977,19985,19988,19995,20000,20014,20022,20031,20047,20051,20053,20056,20059,20064,20069,20070,20090,20094,20099,20103,20105,20130,20140,20145,20146,20147,20150,20152,20155,20156,20158,20160,20162,20164,20166,20168,20170,20186,20205,20246,20255,20262,20269,20270,20275,20308,20321,20330,20351,20371,20377,20383,20386,20389,20395,20404,20421,20426,20430,20433,20437,20440,20447,20455,20464,20487,20491,20505,20511,20519,20522,20538,20542,20570,20574,20621,20625,20629,20632,20680,20683,20684,20695,20698,20742,20754,20760,20770,20775,20777,20778,20779,20795,20812,20826,20848,20851,20852,20886,20899,20900,20901,20903,20927,21026,21027,21059,21060,21061,21062,21063,21064,21065,21066,21067,21068,21069,21070,21084,21109,21151,21291,21292,21310,21320,21345,21350,21352,21356,21359,21362,21365,21367,21370,21372,21374,21383,21384,21396,21398,21446,21452,21453)
		DragonID = new Array(15401,15422,15492,15494,15496,15500,15563,15567,15577,15583,15598,15607,15613,15633,15648,15658,15674,15774,15791,15853,15854,15855,15885,15911,15996,16005,16023,16043,16069,16077,16123,16131,16136,16141,16262,16334,16357,16365,16373,16393,16397,16410,16441,16442,16485,16507,16508,16514,16518,16522,16528,16534,16579,16597,16606,16660,16685,16704,16748,16833,16847,16849,16865,16883,16913,16941,16955,16996,16998,17030,17102,17118,17127,17142,17174,17178,17191,17200,17220,17223,17230,17246,17251,17272,17274,17290,17291,17299,17309,17311,17317,17349,17352,17354,17363,17370,17371,17376,17382,17391,17422,17428,17447,17452,17473,17480,17495,17498,17502,17513,17555,17557,17574,17596,17603,17610,17643,17659,17675,17685,17705,17767,17783,17798,17809,17811,17813,17816,17823,17829,17846,17864,17866,17870,17878,17892,17932,18071,18082,18087,18088,18131,18134,18138,18152,18156,18177,18197,18204,18212,18232,18236,18242,18244,18272,18282,18310,18312,18321,18322,18329,18336,18345,18358,18367,18368,18380,18394,18401,18406,18444,18446,18465,18467,18477,18478,18485,18487,18494,18497,18499,18505,18516,18522,18538,18541,18560,18564,18569,18571,18583,18586,18620,18651,18667,18669,18695,18699,18716,18728,18760,18763,18774,18777,18784,18802,18813,18828,18837,18846,18866,18871,18878,18881,18884,18892,18910,18917,18948,18951,18952,18997,19001,19013,19019,19112,19120,19126,19154,19163,19171,19180,19183,19185,19203,19204,19206,19207,19212,19214,19216,19217,19218,19230,19266,19268,19276,19277,19278,19279,19284,19285,19303,19304,19305,19315,19321,19323,19332,19333,19337,19342,19350,19362,19367,19379,19385,19397,19398,19399,19402,19403,19404,19405,19414,19436,19448,19455,19456,19466,19475,19479,19489,19498,19532,19537,19551,19555,19565,19570,19577,19584,19586,19590,19591,19592,19601,19604,19618,19623,19624,19631,19636,19639,19663,19676,19679,19688,19690,19691,19693,19707,19708,19709,19710,19711,19712,19713,19714,19715,19716,19719,19720,19721,19740,19749,19766,19771,19772,19786,19787,19788,19804,19805,19811,19812,19817,19823,19831,19849,19857,19858,19859,19861,19862,19863,19866,19870,19873,19896,19899,19900,19902,19903,19904,19907,19909,19921,19931,19941,19942,19943,19946,19956,19967,19970,19974,19976,19977,19985,19988,19995,20000,20014,20022,20031,20047,20051,20053,20056,20059,20064,20069,20070,20090,20094,20099,20103,20105,20130,20140,20145,20146,20147,20150,20152,20155,20156,20158,20160,20162,20164,20166,20168,20170,20186,20205,20246,20255,20262,20269,20270,20275,20308,20321,20330,20351,20371,20377,20383,20386,20389,20395,20404,20421,20426,20430,20433,20437,20440,20447,20455,20464,20487,20491,20505,20511,20519,20522,20538,20542,20570,20574,20621,20625,20629,20632,20680,20683,20684,20695,20698,20742,20754,20760,20770,20775,20777,20778,20779,20795,20812,20826,20848,20851,20852,20886,20899,20900,20901,20903,20927,21026,21027,21059,21060,21061,21062,21063,21064,21065,21066,21067,21068,21069,21070,21084,21109,21151,21291,21292,21310,21320,21345,21350,21352,21356,21359,21362,21365,21367,21370,21372,21374,21383,21384,21396,21398,21446,21452,21453)
		TemplarID = new Array(15401,15422,15492,15494,15496,15500,15563,15567,15577,15583,15598,15607,15613,15633,15648,15658,15674,15774,15791,15853,15854,15855,15885,15911,15996,16005,16023,16043,16069,16077,16123,16131,16136,16141,16262,16334,16357,16365,16373,16393,16397,16410,16441,16442,16485,16507,16508,16514,16518,16522,16528,16534,16579,16597,16606,16660,16685,16704,16748,16833,16847,16849,16865,16883,16913,16941,16955,16996,16998,17030,17102,17118,17127,17142,17174,17178,17191,17200,17220,17223,17230,17246,17251,17272,17274,17290,17291,17299,17309,17311,17317,17349,17352,17354,17363,17370,17371,17376,17382,17391,17422,17428,17447,17452,17473,17480,17495,17498,17502,17513,17555,17557,17574,17596,17603,17610,17643,17659,17675,17685,17705,17767,17783,17798,17809,17811,17813,17816,17823,17829,17846,17864,17866,17870,17878,17892,17932,18071,18082,18087,18088,18131,18134,18138,18152,18156,18177,18197,18204,18212,18232,18236,18242,18244,18272,18282,18310,18312,18321,18322,18329,18336,18345,18358,18367,18368,18380,18394,18401,18406,18444,18446,18465,18467,18477,18478,18485,18487,18494,18497,18499,18505,18516,18522,18538,18541,18560,18564,18569,18571,18583,18586,18620,18651,18667,18669,18695,18699,18716,18728,18760,18763,18774,18777,18784,18802,18813,18828,18837,18846,18866,18871,18878,18881,18884,18892,18910,18917,18948,18951,18952,18997,19001,19013,19019,19112,19120,19126,19154,19163,19171,19180,19183,19185,19203,19204,19206,19207,19212,19214,19216,19217,19218,19230,19266,19268,19276,19277,19278,19279,19284,19285,19303,19304,19305,19315,19321,19323,19332,19333,19337,19342,19350,19362,19367,19379,19385,19397,19398,19399,19402,19403,19404,19405,19414,19436,19448,19455,19456,19466,19475,19479,19489,19498,19532,19537,19551,19555,19565,19570,19577,19584,19586,19590,19591,19592,19601,19604,19618,19623,19624,19631,19636,19639,19663,19676,19679,19688,19690,19691,19693,19707,19708,19709,19710,19711,19712,19713,19714,19715,19716,19719,19720,19721,19740,19749,19766,19771,19772,19786,19787,19788,19804,19805,19811,19812,19817,19823,19831,19849,19857,19858,19859,19861,19862,19863,19866,19870,19873,19896,19899,19900,19902,19903,19904,19907,19909,19921,19931,19941,19942,19943,19946,19956,19967,19970,19974,19976,19977,19985,19988,19995,20000,20014,20022,20031,20047,20051,20053,20056,20059,20064,20069,20070,20090,20094,20099,20103,20105,20130,20140,20145,20146,20147,20150,20152,20155,20156,20158,20160,20162,20164,20166,20168,20170,20186,20205,20246,20255,20262,20269,20270,20275,20308,20321,20330,20351,20371,20377,20383,20386,20389,20395,20404,20421,20426,20430,20433,20437,20440,20447,20455,20464,20487,20491,20505,20511,20519,20522,20538,20542,20570,20574,20621,20625,20629,20632,20680,20683,20684,20695,20698,20742,20754,20760,20770,20775,20777,20778,20779,20795,20812,20826,20848,20851,20852,20886,20899,20900,20901,20903,20927,21026,21027,21059,21060,21061,21062,21063,21064,21065,21066,21067,21068,21069,21070,21084,21109,21151,21291,21292,21310,21320,21345,21350,21352,21356,21359,21362,21365,21367,21370,21372,21374,21383,21384,21396,21398,21446,21452,21453)
		ExportIDs();
	}
	
	public static function ExportIDs(){
		if(SharedID.length>0) ExportShared();
		else if(LumieID.length>0) ExportLumie();
		else if(DragonID.length>0) ExportDragon();
		else if(TemplarID.length>0) ExportTemplar();
		else{
			UtilsBase.PrintChatText("Done")
		}
	}
	
	public static function Replace(Str:String){
		return Str.split("\n").join("&&");
	}
	
	public static function ExportShared() {
		if (SharedID.length>0){
			var task = SharedID.pop();
			var questID = QuestsBase.GetMainQuestIDByQuestID(task);
			var solvedText = Replace(LDBFormat.LDBGetText("QuestTaskSolved", task));;
			var QuestName = QuestsBase.GetQuest(questID, false, true).m_MissionName;
			if (!QuestName) QuestName = QuestsBase.GetQuest(questID, false, false).m_MissionName;
			if(QuestName && solvedText){
				var msg = "Faction=Shared QuestID=" + string(questID) + " QuestName="+QuestName +" TaskID=" + string(task) + " Report=" + solvedText+"||";
				LogBase.Warning("DoubleAgent", msg);
			}
			setTimeout(Delegate.create(Main, ExportShared), 50);
		}
		else{
			UtilsBase.PrintChatText("Shared Exported")
			ExportIDs();
		}
	}
	
	public static function ExportLumie() {
		if (LumieID.length>0){
			var task = LumieID.pop();
			var questID = QuestsBase.GetMainQuestIDByQuestID(task);
			var solvedText = Replace(LDBFormat.LDBGetText("QuestTaskSolvedIlluminati", task));;
			var QuestName = QuestsBase.GetQuest(questID, false, true).m_MissionName;
			if (!QuestName) QuestName = QuestsBase.GetQuest(questID, false, false).m_MissionName;
			if(QuestName && solvedText){
				var msg = "Faction=Lumie QuestID=" + string(questID) + " QuestName="+QuestName +" TaskID=" + string(task) + " Report=" + solvedText+"||";
				LogBase.Warning("DoubleAgent", msg);
			}
			setTimeout(Delegate.create(Main, ExportLumie), 50);
		}
		else{
			UtilsBase.PrintChatText("Lumie Exported")
			ExportIDs();
		}
	}
	
	public static function ExportTemplar() {
		if (TemplarID.length>0){
			var task = TemplarID.pop();
			var questID = QuestsBase.GetMainQuestIDByQuestID(task);
			var solvedText = Replace(LDBFormat.LDBGetText("QuestTaskSolvedTemplar", task));;
			var QuestName = QuestsBase.GetQuest(questID, false, true).m_MissionName;
			if (!QuestName) QuestName = QuestsBase.GetQuest(questID, false, false).m_MissionName;
			if(QuestName && solvedText){
				var msg = "Faction=Templar QuestID=" + string(questID) + " QuestName="+QuestName +" TaskID=" + string(task) + " Report=" + solvedText+"||";
				LogBase.Warning("DoubleAgent", msg);
			}
			setTimeout(Delegate.create(Main, ExportTemplar), 50);
		}
		else{
			UtilsBase.PrintChatText("Templar Exported")
			ExportIDs();
		}
	}
	
	public static function ExportDragon() {
		if (DragonID.length>0){
			var task = DragonID.pop();
			var questID = QuestsBase.GetMainQuestIDByQuestID(task);
			var solvedText = Replace(LDBFormat.LDBGetText("QuestTaskSolvedDragon", task));;
			var QuestName = QuestsBase.GetQuest(questID, false, true).m_MissionName;
			if (!QuestName) QuestName = QuestsBase.GetQuest(questID, false, false).m_MissionName;
			if(QuestName && solvedText){
				var msg = "Faction=Dragon QuestID=" + string(questID) + " QuestName="+QuestName +" TaskID=" + string(task) + " Report=" + solvedText+"||";
				LogBase.Warning("DoubleAgent", msg);
			}
			setTimeout(Delegate.create(Main, ExportDragon), 50);
		}
		else{
			UtilsBase.PrintChatText("Dragon Exported")
			ExportIDs();
		}
	}
}
